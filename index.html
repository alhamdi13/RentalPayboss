<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rental Manager</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- CSS Kustom untuk Animasi dan Struk -->
  <style>
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      z-index: 1000;
      animation: fadeInOut 3s ease-in-out;
    }
    .slide-in {
      animation: slideIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .pulse-animation {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    .gradient-bg {
      background-image: linear-gradient(to right, #06b6d4, #3b82f6);
    }
    .gradient-secondary {
      background-image: linear-gradient(to right, #f59e0b, #ef4444);
    }
    .card-shadow {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Struk Printer-friendly */
    .receipt {
      font-family: 'Courier New', Courier, monospace;
      color: #000;
      max-width: 300px; /* Lebar umum struk thermal */
      margin: 0 auto;
      font-size: 12px;
      line-height: 1.4;
    }
    .receipt-header { text-align: center; margin-bottom: 10px; }
    .receipt-title { font-size: 16px; font-weight: bold; text-transform: uppercase; }
    .receipt-address { font-size: 11px; }
    .receipt-body { margin-bottom: 10px; }
    .receipt-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
    .receipt-row span:first-child { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; }
    .receipt-separator { border-top: 1px dashed #000; margin: 8px 0; }
    .receipt-total { font-weight: bold; font-size: 14px; padding-top: 5px; }
    .receipt-footer { text-align: center; margin-top: 10px; font-size: 11px; }
    
    @keyframes fadeInOut {
      0%, 100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
      15%, 85% { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    @keyframes slideIn {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }

    /* Print Styles */
    @media print {
      body * {
        visibility: hidden;
      }
      #receipt-modal, #receipt-modal * {
        visibility: visible;
      }
      #receipt-modal {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: #fff !important;
        padding: 0;
      }
      #receipt-modal > div {
        width: 100% !important;
        max-width: 100% !important;
        box-shadow: none;
        padding: 10px;
        background-color: #fff !important;
      }
      #receipt-content {
        color: #000 !important;
      }
      /* Sembunyikan tombol saat print */
      #receipt-modal .flex.gap-3, #receipt-modal .flex.items-center.justify-between {
        display: none;
      }
    }
  </style>

  <!-- SATU BLOK SCRIPT TUNGGAL UNTUK MENGHINDARI RACE CONDITION -->
  <script type="module">
    // Impor fungsi-fungsi yang kita butuhkan dari Firebase SDK (Versi diperbarui)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    // import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      doc, 
      setDoc, 
      onSnapshot,
      query,
      where,
      getDocs,
      setLogLevel // Ditambahkan untuk debugging
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // DEFINISI showToast dipindahkan ke atas agar bisa menangani error
    window.showToast = function(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.style.backgroundColor = type === 'success' ? '#10b981' : '#ef4444';
      toast.style.color = '#ffffff';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // -----------------------------------------------------------------
    // KONFIGURASI FIREBASE (DIPERBAIKI - Menggunakan variabel global)
    // -----------------------------------------------------------------
    
    // Ambil konfigurasi dari variabel global yang disediakan oleh lingkungan
    const firebaseConfig = JSON.parse(
      typeof __firebase_config !== 'undefined' 
        ? __firebase_config 
        : '{}'
    );
    
    // Ambil App ID dari variabel global
    // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // --- PERBAIKAN: Hardcode App ID agar cocok dengan Firebase Rules ---
    // Aturan Firebase Anda di-set untuk App ID spesifik ini.
    const appId = "1:759463472912:web:f209186894c5fc6cb3ff95";
    
    if (typeof __app_id !== 'undefined' && __app_id !== appId) {
        console.warn("Peringatan: App ID lingkungan (" + __app_id + ") tidak cocok dengan App ID di kode (" + appId + ").");
    }


    // Periksa apakah konfigurasi ada
    if (!firebaseConfig.apiKey) {
        console.error("Konfigurasi Firebase tidak ditemukan!");
        showToast('Error: Konfigurasi server tidak ditemukan.', 'error');
    }

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    // const analytics = getAnalytics(app); // Dihapus karena tidak digunakan
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Aktifkan log untuk debugging
    setLogLevel('Debug');

    // Buat referensi koleksi (DIPERBAIKI - Menggunakan path yang benar)
    // Path harus /artifacts/{appId}/public/data/{collectionName}
    const rentalsCollection = collection(db, "artifacts", appId, "public", "data", "rentals");

    // Pasang variabel global
    window.db = db;
    window.auth = auth;
    window.rentalsCollection = rentalsCollection;
    window.addDoc = addDoc;
    window.doc = doc;
    window.setDoc = setDoc;
    window.onSnapshot = onSnapshot;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;

    // Pasang listener untuk data rental
    function setupRealtimeListener(dataHandler) {
      // Periksa apakah rentalsCollection sudah terdefinisi
      if (!window.rentalsCollection) {
        console.error("rentalsCollection belum diinisialisasi.");
        showToast('Gagal terhubung ke database.', 'error');
        return;
      }
      
      const q = query(window.rentalsCollection);
      
      onSnapshot(q, (snapshot) => {
        const rentals = snapshot.docs.map(doc => ({
          ...doc.data(),
          __backendId: doc.id // Kita simpan ID dokumen Firebase
        }));
        dataHandler.onDataChanged(rentals);
      }, (error) => {
        console.error("Error listening to rentals: ", error);
        showToast('Gagal memuat data real-time: ' + error.message, 'error');
      });
    }
    
    window.setupRealtimeListener = setupRealtimeListener;

    // -------------------------------------------------
    // SEMUA KODE APLIKASI SEKARANG ADA DI SINI
    // -------------------------------------------------

    // KONSTANTA APLIKASI
    const REFERENCE_ROOMS = [
      { id: 'billiard-1', name: 'Billiard 1', type: 'billiard', icon: 'üé±' },
      { id: 'karaoke-1', name: 'Karaoke 1', type: 'karaoke', icon: 'üé§' },
      { id: 'karaoke-2', name: 'Karaoke 2', type: 'karaoke', icon: 'üé§' },
      { id: 'karaoke-3', name: 'Karaoke 3', type: 'karaoke', icon: 'üé§' },
      { id: 'massage-1', name: 'Kursi Pijat', type: 'massage', icon: 'üíÜ' }
    ];

    // defaultConfig
    const defaultConfig = {
      background_color: '#f0f9ff',
      surface_color: '#ffffff',
      text_color: '#1e293b',
      primary_action_color: '#06b6d4',
      secondary_action_color: '#f59e0b',
      app_title: 'One Stop Entertainment Pay Boss',
      billiard_price: '50000',
      karaoke_price: '75000',
      massage_price: '30000',
      font_family: 'Inter',
      font_size: 16,
      user_role: 'kasir'
    };

    // -------------------------------------------------
    // FAKE SDK IMPLEMENTATION (Menggunakan Firebase)
    // -------------------------------------------------

    // (1) Pengganti elementSdk
    const appConfig = (function() {
      // Coba ambil config tersimpan dari localStorage
      let savedConfig = {};
      try {
        const stored = localStorage.getItem('rentalConfig');
        if (stored) {
          savedConfig = JSON.parse(stored);
        }
      } catch (e) {
        console.warn("Gagal memuat config dari localStorage", e);
      }

      // Gabungkan dengan defaultConfig (sekarang sudah terdefinisi)
      let currentConfig = { ...defaultConfig, ...savedConfig };

      return {
        // Berikan config saat ini
        get config() {
          return currentConfig;
        },
        // Fungsi untuk menyimpan config baru
        setConfig(newConfig) {
          currentConfig = { ...currentConfig, ...newConfig };
          try {
            // Simpan ke localStorage agar persisten
            localStorage.setItem('rentalConfig', JSON.stringify(currentConfig));
          } catch (e) {
            console.warn("Gagal menyimpan config ke localStorage", e);
          }
          // Panggil onConfigChange secara manual
          onConfigChange(currentConfig);
        }
      };
    })();

    // (2) Pengganti dataSdk
    const dataSdk = {
      // Fungsi untuk membuat data baru di Firestore
      async create(data) {
        try {
          // Gunakan window.rentalsCollection yang sudah diinisialisasi dengan path benar
          await window.addDoc(window.rentalsCollection, data);
          return { isOk: true };
        } catch (error) {
          console.error("Error creating document: ", error);
          return { isOk: false, error };
        }
      },
      
      // Fungsi untuk update data di Firestore
      async update(rental) {
        // Ambil ID dokumen dan hapus dari objek
        const docId = rental.__backendId;
        if (!docId) {
          console.error("dataSdk.update dipanggil tanpa __backendId");
          return { isOk: false, error: "Missing document ID" };
        }
        
        // Buat salinan data tanpa __backendId
        const { __backendId, ...dataToSave } = rental;
        
        try {
          // Gunakan path lengkap dari rentalsCollection
          const docRef = window.doc(window.rentalsCollection, docId);
          await window.setDoc(docRef, dataToSave, { merge: true }); // Gunakan setDoc dengan merge
          return { isOk: true };
        } catch (error) {
          // *** TAMBAHAN LOGGING DI SINI ***
          console.error("Error di dalam dataSdk.update: ", error);
          console.error("Data yang gagal disimpan: ", dataToSave);
          console.error("Doc ID: ", docId);
          return { isOk: false, error };
        }
      },
      
      // Fungsi init untuk memulai listener
      async init(dataHandler) {
        try {
          // Atur listener real-time
          window.setupRealtimeListener(dataHandler);
          return { isOk: true };
        } catch (error) {
          console.error("Error setting up listener: ", error);
          return { isOk: false, error };
        }
      }
    };
    
    // Pasang SDK palsu kita ke window agar kode lama berfungsi
    window.elementSdk = appConfig;
    window.dataSdk = dataSdk;


    // =================================================
    // KODE APLIKASI ASLI ANDA (Sisa kode)
    // =================================================

    let allRentals = [];
    let activeTimers = new Map();

    function getPriceForRoom(roomType, config) {
      const prices = {
        'billiard': parseInt(config.billiard_price || defaultConfig.billiard_price),
        'karaoke': parseInt(config.karaoke_price || defaultConfig.karaoke_price),
        'massage': parseInt(config.massage_price || defaultConfig.massage_price)
      };
      return prices[roomType] || 0;
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
      }).format(amount);
    }

    function formatTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function calculateDuration(startTime) {
      const now = new Date();
      const start = new Date(startTime);
      const diffMs = now - start;
      const diffHours = diffMs / (1000 * 60 * 60);
      return Math.max(0, diffHours);
    }

    function startTimer(rental, config) {
      if (activeTimers.has(rental.__backendId)) {
        clearInterval(activeTimers.get(rental.__backendId));
      }

      // Perbarui tampilan segera
      updateRentalDisplay(rental, config);
      
      const timer = setInterval(() => {
        updateRentalDisplay(rental, config);
      }, 60000); // Perbarui setiap menit

      activeTimers.set(rental.__backendId, timer);
    }

    function stopTimer(rentalId) {
      if (activeTimers.has(rentalId)) {
        clearInterval(activeTimers.get(rentalId));
        activeTimers.delete(rentalId);
      }
    }

    function updateRentalDisplay(rental, config) {
      const card = document.querySelector(`[data-rental-id="${rental.__backendId}"]`);
      if (!card) return;

      const duration = calculateDuration(rental.start_time);
      const hours = Math.floor(duration);
      const minutes = Math.floor((duration - hours) * 60);
      
      let durationDisplay, bookingInfo;
      
      if (rental.booking_type === 'open') {
          durationDisplay = `${hours} jam ${minutes} menit`;
          bookingInfo = '‚è∞ Open Time';
      } else {
          const bookedHours = parseInt(rental.booking_type);
          const remainingTime = bookedHours - duration;
          
          if (remainingTime > 0) {
              const remainingHours = Math.floor(remainingTime);
              const remainingMinutes = Math.floor((remainingTime - remainingHours) * 60);
              durationDisplay = `Sisa: ${remainingHours}j ${remainingMinutes}m`;
              bookingInfo = `üïê ${bookedHours} Jam (Booked)`;
          } else {
              const overTime = duration - bookedHours;
              const overHours = Math.floor(overTime);
              const overMinutes = Math.floor((overTime - overHours) * 60);
              durationDisplay = `Lewat: ${overHours}j ${overMinutes}m`;
              bookingInfo = `üïê ${bookedHours} Jam (Expired)`;
          }
      }

      const durationEl = card.querySelector('.duration-display');
      if (durationEl) {
        durationEl.textContent = durationDisplay;
      }
      
      const bookingInfoEl = card.querySelector('.booking-info');
      if (bookingInfoEl) {
          bookingInfoEl.textContent = bookingInfo;
      }

      const room = REFERENCE_ROOMS.find(r => r.id === rental.room_id);
      if (!room) return; // Tambahan keamanan jika ruangan tidak ditemukan
      
      const pricePerHour = getPriceForRoom(room.type, config);
      
      // Update harga hanya jika 'open time'
      if (rental.booking_type === 'open') {
          const currentPrice = Math.ceil(duration * pricePerHour);
          const priceEl = card.querySelector('.current-price');
          if (priceEl) {
            priceEl.textContent = formatCurrency(currentPrice);
          }
      }
    }

    async function startRental(roomId, customerName, phone, bookingType, config) {
      if (allRentals.filter(r => r.status === 'active').length >= 999) {
        showToast('Maksimum 999 rental aktif tercapai', 'error');
        return;
      }

      const startTime = new Date().toISOString();
      const room = REFERENCE_ROOMS.find(r => r.id === roomId);
      const pricePerHour = getPriceForRoom(room.type, config);
      
      let totalPrice = 0;
      if (bookingType !== 'open') {
        const bookedHours = parseInt(bookingType);
        totalPrice = bookedHours * pricePerHour;
      }
      
      const rentalData = {
        room_id: roomId,
        customer_name: customerName,
        phone: phone,
        start_time: startTime,
        end_time: null,
        duration_hours: 0,
        total_price: totalPrice,
        status: 'active',
        booking_type: bookingType
      };

      const loadingBtn = document.querySelector(`[data-room-id="${roomId}"] .start-btn`);
      if (loadingBtn) {
        loadingBtn.disabled = true;
        loadingBtn.textContent = 'Memproses...';
      }

      // Gunakan SDK palsu (Firebase)
      const result = await window.dataSdk.create(rentalData);
      
      if (result.isOk) {
        const bookingInfo = bookingType === 'open' ? 'Open Time' : `${bookingType} Jam`;
        showToast(`${room.name} berhasil dimulai! (${bookingInfo})`);
        closeModal();
      } else {
        showToast('Gagal memulai rental', 'error');
        if (loadingBtn) {
          loadingBtn.disabled = false;
          loadingBtn.textContent = 'Mulai Rental';
        }
      }
    }

    // *** FUNGSI HELPER BARU ***
    // Dibungkus agar aman dipanggil dari HTML
    function handleEndRentalClick(rentalId) {
      console.log(`handleEndRentalClick dipanggil untuk ID: ${rentalId}`);
      // Temukan rental dari state allRentals saat ini
      const rental = window.allRentals.find(r => r.__backendId === rentalId);
      const config = window.elementSdk.config;
    
      // Panggil fungsi endRental yang asli
      // Pengecekan 'if (!rental)' di dalam endRental akan menangani jika tidak ditemukan
      window.endRental(rental, config);
    }
    window.handleEndRentalClick = handleEndRentalClick; // Pasang ke window

    // Fungsi endRental yang asli, sekarang dipanggil oleh handleEndRentalClick
    async function endRental(rental, config) {
      if (!rental) {
        console.error("Fungsi endRental dipanggil tanpa data rental (rental adalah undefined).");
        showToast("Error: Data rental tidak ditemukan", "error");
        return;
      }

      const endTime = new Date().toISOString();
      const duration = calculateDuration(rental.start_time);
      const room = REFERENCE_ROOMS.find(r => r.id === rental.room_id);
      
      if (!room) {
        console.error(`Error: Ruangan dengan ID "${rental.room_id}" tidak ditemukan di REFERENCE_ROOMS.`);
        showToast("Error: Konfigurasi ruangan tidak ditemukan", "error");
        return;
      }

      const pricePerHour = getPriceForRoom(room.type, config);
      
      let totalPrice;
      if (rental.booking_type === 'open') {
          // Hitung harga final berdasarkan durasi
          totalPrice = Math.ceil(duration * pricePerHour);
      } else {
          // Harga sudah di-set saat booking
          totalPrice = rental.total_price;
          // Mungkin ada biaya tambahan jika over time, tapi kita sederhanakan
          // Jika main lebih lama dari waktu booking, hitung ulang
          const bookedHours = parseInt(rental.booking_type);
          if (duration > bookedHours) {
              // Hitung ulang berdasarkan durasi aktual
              totalPrice = Math.ceil(duration * pricePerHour);
              showToast('Waktu booking terlampaui, harga disesuaikan.', 'success');
          }
      }

      const updatedRental = {
        ...rental,
        end_time: endTime,
        duration_hours: parseFloat(duration.toFixed(2)),
        total_price: totalPrice,
        status: 'completed'
      };

      const loadingBtn = document.querySelector(`[data-rental-id="${rental.__backendId}"] .end-btn`);
      if (loadingBtn) {
        loadingBtn.disabled = true;
        loadingBtn.textContent = 'Memproses...';
      }

      // Gunakan SDK palsu (Firebase)
      const result = await window.dataSdk.update(updatedRental);
      
      if (result.isOk) {
        stopTimer(rental.__backendId);
        showToast(`${room.name} selesai - Total: ${formatCurrency(totalPrice)}`);
        
        // Tampilkan struk
        showReceiptModal(updatedRental, room, config);
      } else {
        // *** LOGGING DIPERBARUI DI SINI ***
        console.error("GAGAL UPDATE RENTAL:", result.error);
        showToast('Gagal menyelesaikan rental. Cek konsol (F12) untuk error.', 'error');
        if (loadingBtn) {
          loadingBtn.disabled = false;
          loadingBtn.textContent = 'Selesai';
        }
      }
    }
    window.endRental = endRental; // Tetap pasang ke window

    function showReceiptModal(rental, room, config) {
      const modal = document.createElement('div');
      modal.id = 'receipt-modal';
      modal.className = 'fixed inset-0 flex items-center justify-center z-50 p-4';
      modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
      
      const receiptDate = new Date(rental.end_time);
      const receiptNumber = `RC${Date.now().toString().slice(-6)}`;
      
      modal.innerHTML = `
        <div class="rounded-lg p-6 max-w-md w-full slide-in" style="background-color: ${config.surface_color || defaultConfig.surface_color};">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold" style="color: ${config.text_color || defaultConfig.text_color};">
              üí≥ Struk Pembayaran
            </h2>
            <button onclick="closeReceiptModal()" class="text-2xl" style="color: ${config.text_color || defaultConfig.text_color};">&times;</button>
          </div>
          
          <div id="receipt-content" class="receipt">
            <div class="receipt-header">
              <div class="receipt-title">PAY BOSS CAFE</div>
              <div class="receipt-address">Jl. Tanjung Permai No 2 RT 07 Pembataan</div>
              <div class="receipt-address">Murung Pudak. Tabalong</div>
              <div class="receipt-address">HP : 0811-5194-456</div>
            </div>
            
            <div class="receipt-body">
              <div class="receipt-row">
                <span>No. Struk:</span>
                <span>${receiptNumber}</span>
              </div>
              <div class="receipt-row">
                <span>Tanggal:</span>
                <span>${receiptDate.toLocaleDateString('id-ID')}</span>
              </div>
              <div class="receipt-row">
                <span>Waktu:</span>
                <span>${receiptDate.toLocaleTimeString('id-ID')}</span>
              </div>
              <div class="receipt-row">
                <span>Kasir:</span>
                <span>Admin</span>
              </div>
              
              <div class="receipt-separator"></div>
              
              <div class="receipt-row">
                <span>Pelanggan:</span>
                <span>${rental.customer_name}</span>
              </div>
              <div class="receipt-row">
                <span>Telepon:</span>
                <span>${rental.phone}</span>
              </div>
              
              <div class="receipt-separator"></div>
              
              <div class="receipt-row">
                <span>${room.name}</span>
                <span></span>
              </div>
              <div class="receipt-row">
                <span>Tipe Booking:</span>
                <span>${rental.booking_type === 'open' ? 'Open Time' : rental.booking_type + ' Jam'}</span>
              </div>
              <div class="receipt-row">
                <span>Mulai:</span>
                <span>${formatTime(rental.start_time)}</span>
              </div>
              <div class="receipt-row">
                <span>Selesai:</span>
                <span>${formatTime(rental.end_time)}</span>
              </div>
              <div class="receipt-row">
                <span>Durasi:</span>
                <span>${rental.duration_hours.toFixed(1)} jam</span>
              </div>
              <div class="receipt-row">
                <span>Harga/jam:</span>
                <span>${formatCurrency(getPriceForRoom(room.type, config))}</span>
              </div>
              
              <div class="receipt-separator"></div>
              
              <div class="receipt-row receipt-total">
                <span>TOTAL BAYAR:</span>
                <span>${formatCurrency(rental.total_price)}</span>
              </div>
            </div>
            
            <div class="receipt-footer">
              <div>Instagram PAY BOSS CAFE</div>
              <div>Terimakasih atas kunjungan anda.</div>
              <div style="margin-top: 10px;">Instagram : @Payboss.cafe</div>
              <div>Wifi : Pay Boss Cafe</div>
              <div>Password : P4yB0sSC4F3</div>
            </div>
          </div>
          
          <div class="flex gap-3 mt-6">
            <button onclick="printReceipt()" class="flex-1 py-3 rounded-lg font-semibold transition-all" 
              style="background-color: ${config.primary_action_color || defaultConfig.primary_action_color}; color: #ffffff;">
              üñ®Ô∏è Cetak Struk
            </button>
            <button onclick="closeReceiptModal()" class="flex-1 py-3 rounded-lg font-semibold transition-all" 
              style="background-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; color: #ffffff;">
              Tutup
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function printReceipt() {
      window.print();
    }

    function closeReceiptModal() {
      const modal = document.getElementById('receipt-modal');
      if (modal) modal.remove();
    }

    function openStartModal(roomId, config) {
      const room = REFERENCE_ROOMS.find(r => r.id === roomId);
      const pricePerHour = getPriceForRoom(room.type, config);
      
      const modal = document.createElement('div');
      modal.id = 'rental-modal';
      modal.className = 'fixed inset-0 flex items-center justify-center z-50 p-4';
      modal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
      
      modal.innerHTML = `
        <div class="rounded-lg p-6 max-w-md w-full slide-in" style="background-color: ${window.elementSdk.config.surface_color || defaultConfig.surface_color};">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold" style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 1.5}px;">
              ${room.icon} ${room.name}
            </h2>
            <button onclick="closeModal()" class="text-2xl" style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color};">&times;</button>
          </div>
          
          <div class="mb-4 p-3 rounded" style="background-color: ${window.elementSdk.config.background_color || defaultConfig.background_color};">
            <p style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; font-size: ${window.elementSdk.config.font_size || defaultConfig.font_size}px;">
              Harga: <span class="font-bold">${formatCurrency(pricePerHour)}/jam</span>
            </p>
          </div>

          <form id="start-rental-form" class="space-y-4">
            <div>
              <label class="block mb-2 font-medium" style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; font-size: ${window.elementSdk.config.font_size || defaultConfig.font_size}px;">Nama Pelanggan</label>
              <input type="text" id="customer-name" required class="w-full px-4 py-2 rounded border-2" 
                style="background-color: ${window.elementSdk.config.background_color || defaultConfig.background_color}; 
                       color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; 
                       border-color: ${window.elementSdk.config.secondary_action_color || defaultConfig.secondary_action_color};
                       font-size: ${window.elementSdk.config.font_size || defaultConfig.font_size}px;"
                placeholder="Masukkan nama">
            </div>
            
            <div>
              <label class="block mb-2 font-medium" style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; font-size: ${window.elementSdk.config.font_size || defaultConfig.font_size}px;">Nomor Telepon</label>
              <input type="tel" id="customer-phone" required class="w-full px-4 py-2 rounded border-2" 
                style="background-color: ${window.elementSdk.config.background_color || defaultConfig.background_color}; 
                       color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; 
                       border-color: ${window.elementSdk.config.secondary_action_color || defaultConfig.secondary_action_color};
                       font-size: ${window.elementSdk.config.font_size || defaultConfig.font_size}px;"
                placeholder="08xx xxxx xxxx">
            </div>

            <div>
              <label class="block mb-3 font-medium" style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; font-size: ${window.elementSdk.config.font_size || defaultConfig.font_size}px;">Pilih Durasi Booking</label>
              <div class="grid grid-cols-2 gap-2">
                <label class="booking-option cursor-pointer">
                  <input type="radio" name="booking-type" value="open" checked class="sr-only">
                  <div class="p-3 rounded-lg border-2 text-center transition-all" 
                    style="border-color: ${window.elementSdk.config.primary_action_color || defaultConfig.primary_action_color}; 
                           background-color: ${window.elementSdk.config.primary_action_color + '20'};"> <!-- Warna terpilih -->
                    <div style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 0.9}px;">
                      ‚è∞ Open Time
                    </div>
                    <div style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; opacity: 0.7; font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 0.75}px;">
                      Bayar sesuai durasi
                    </div>
                  </div>
                </label>
                
                <label class="booking-option cursor-pointer">
                  <input type="radio" name="booking-type" value="1" class="sr-only">
                  <div class="p-3 rounded-lg border-2 text-center transition-all" 
                    style="border-color: ${window.elementSdk.config.secondary_action_color || defaultConfig.secondary_action_color}; 
                           background-color: ${window.elementSdk.config.background_color || defaultConfig.background_color};">
                    <div style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 0.9}px;">
                      1Ô∏è‚É£ 1 Jam
                    </div>
                    <div style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; opacity: 0.7; font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 0.75}px;">
                      ${formatCurrency(pricePerHour)}
                    </div>
                  </div>
                </label>
                
                <label class="booking-option cursor-pointer">
                  <input type="radio" name="booking-type" value="2" class="sr-only">
                  <div class="p-3 rounded-lg border-2 text-center transition-all" 
                    style="border-color: ${window.elementSdk.config.secondary_action_color || defaultConfig.secondary_action_color}; 
                           background-color: ${window.elementSdk.config.background_color || defaultConfig.background_color};">
                    <div style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 0.9}px;">
                      2Ô∏è‚É£ 2 Jam
                    </div>
                    <div style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; opacity: 0.7; font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 0.75}px;">
                      ${formatCurrency(pricePerHour * 2)}
                    </div>
                  </div>
                </label>
                
                <label class="booking-option cursor-pointer">
                  <input type="radio" name="booking-type" value="3" class="sr-only">
                  <div class="p-3 rounded-lg border-2 text-center transition-all" 
                    style="border-color: ${window.elementSdk.config.secondary_action_color || defaultConfig.secondary_action_color}; 
                           background-color: ${window.elementSdk.config.background_color || defaultConfig.background_color};">
                    <div style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 0.9}px;">
                      3Ô∏è‚É£ 3 Jam
                    </div>
                    <div style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; opacity: 0.7; font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 0.75}px;">
                      ${formatCurrency(pricePerHour * 3)}
                    </div>
                  </div>
                </label>
              </div>
            </div>

            <button type="submit" data-room-id="${roomId}" class="start-btn w-full py-3 rounded-lg font-semibold transition-all" 
              style="background-color: ${window.elementSdk.config.primary_action_color || defaultConfig.primary_action_color}; 
                     color: #ffffff;
                     font-size: ${window.elementSdk.config.font_size || defaultConfig.font_size}px;">
              Mulai Rental
            </button>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      document.getElementById('customer-name').focus();

      // Handle booking option selection
      const bookingOptions = modal.querySelectorAll('.booking-option');
      bookingOptions.forEach(option => {
        option.addEventListener('click', () => {
          // Remove selected state from all options
          bookingOptions.forEach(opt => {
            const div = opt.querySelector('div');
            div.style.borderColor = window.elementSdk.config.secondary_action_color || defaultConfig.secondary_action_color;
            div.style.backgroundColor = window.elementSdk.config.background_color || defaultConfig.background_color;
          });
          
          // Add selected state to clicked option
          const selectedDiv = option.querySelector('div');
          selectedDiv.style.borderColor = window.elementSdk.config.primary_action_color || defaultConfig.primary_action_color;
          selectedDiv.style.backgroundColor = window.elementSdk.config.primary_action_color + '20'; // 20 hex = 12.5% opacity
          
          // Check the radio button
          option.querySelector('input[type="radio"]').checked = true;
        });
      });

      document.getElementById('start-rental-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const customerName = document.getElementById('customer-name').value;
        const phone = document.getElementById('customer-phone').value;
        const bookingType = document.querySelector('input[name="booking-type"]:checked').value;
        await startRental(roomId, customerName, phone, bookingType, window.elementSdk.config);
      });
    }

    function closeModal() {
      const modal = document.getElementById('rental-modal');
      if (modal) modal.remove();
    }

    function showRoleSelector() {
      const modal = document.createElement('div');
      modal.id = 'role-modal';
      modal.className = 'fixed inset-0 flex items-center justify-center z-50 p-4';
      modal.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
      
      modal.innerHTML = `
        <div class="rounded-lg p-8 max-w-md w-full slide-in text-center" style="background-color: ${window.elementSdk.config.surface_color || defaultConfig.surface_color};">
          <h2 class="font-bold mb-6" style="color: ${window.elementSdk.config.text_color || defaultConfig.text_color}; font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 1.8}px;">
            üîê Pilih Role Anda
          </h2>
          
          <div class="space-y-4">
            <button onclick="selectRole('kasir')" class="w-full p-4 rounded-lg border-2 transition-all hover:scale-105" 
              style="background-color: ${window.elementSdk.config.background_color || defaultConfig.background_color}; 
                     border-color: ${window.elementSdk.config.primary_action_color || defaultConfig.primary_action_color}; 
                     color: ${window.elementSdk.config.text_color || defaultConfig.text_color};">
              <div style="font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 2}px;">üë®‚Äçüíº</div>
              <div class="font-semibold mt-2" style="font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 1.2}px;">KASIR</div>
              <div style="opacity: 0.7; font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 0.9}px;">Kelola rental harian</div>
            </button>
            
            <button onclick="selectRole('manager')" class="w-full p-4 rounded-lg border-2 transition-all hover:scale-105" 
              style="background-color: ${window.elementSdk.config.background_color || defaultConfig.background_color}; 
                     border-color: ${window.elementSdk.config.secondary_action_color || defaultConfig.secondary_action_color}; 
                     color: ${window.elementSdk.config.text_color || defaultConfig.text_color};">
              <div style="font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 2}px;">üëë</div>
              <div class="font-semibold mt-2" style="font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 1.2}px;">MANAGER</div>
              <div style="opacity: 0.7; font-size: ${(window.elementSdk.config.font_size || defaultConfig.font_size) * 0.9}px;">Akses lengkap + laporan</div>
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function selectRole(role) {
      // Gunakan SDK palsu
      window.elementSdk.setConfig({ user_role: role });
      const modal = document.getElementById('role-modal');
      if (modal) modal.remove();
    }

    function renderApp(config) {
      const app = document.getElementById('app');
      
      // Hentikan semua timer lama sebelum me-render ulang
      activeTimers.forEach(timer => clearInterval(timer));
      activeTimers.clear();

      // Urutkan data: rental aktif dulu, lalu rental selesai terbaru
      const activeRentals = allRentals.filter(r => r.status === 'active');
      const completedRentals = allRentals
        .filter(r => r.status === 'completed')
        .sort((a, b) => new Date(b.end_time) - new Date(a.end_time)); // Urutkan terbaru dulu

      const availableRooms = REFERENCE_ROOMS.filter(room => 
        !activeRentals.some(rental => rental.room_id === room.id)
      );

      const isManager = config.user_role === 'manager';
      const today = new Date().toDateString();
      const todayRentals = completedRentals.filter(rental => {
        const rentalDate = new Date(rental.end_time).toDateString();
        return rentalDate === today;
      });
      
      const todayRevenue = todayRentals.reduce((sum, rental) => sum + (rental.total_price || 0), 0);
      const totalRevenue = completedRentals.reduce((sum, rental) => sum + (rental.total_price || 0), 0);


      app.innerHTML = `
        <div class="min-h-full p-6" style="background-color: ${config.background_color || defaultConfig.background_color}; font-family: ${config.font_family || defaultConfig.font_family};">
          <div class="max-w-7xl mx-auto">
            <header class="mb-8">
              <div class="flex items-center justify-between mb-4">
                <div class="text-center flex-1">
                  <h1 class="font-bold mb-2" style="color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 2}px;">
                    ${config.app_title || defaultConfig.app_title}
                  </h1>
                  <p style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.8; font-size: ${(config.font_size || defaultConfig.font_size) * 0.9}px;">
                    Sistem Manajemen Rental Otomatis
                  </p>
                </div>
                <div class="flex items-center gap-4">
                  <div class="text-right">
                    <div class="flex items-center gap-2 mb-1">
                      <span style="font-size: ${(config.font_size || defaultConfig.font_size) * 1.2}px;">
                        ${isManager ? 'üëë' : 'üë®‚Äçüíº'}
                      </span>
                      <span class="font-semibold" style="color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 1.1}px;">
                        ${isManager ? 'MANAGER' : 'KASIR'}
                      </span>
                    </div>
                    <button onclick="showRoleSelector()" class="text-sm px-3 py-1 rounded transition-all" 
                      style="background-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; 
                             color: #ffffff; 
                             font-size: ${(config.font_size || defaultConfig.font_size) * 0.8}px;">
                      Ganti Role
                    </button>
                  </div>
                </div>
              </div>
              
              ${isManager ? `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                  <div class="rounded-xl p-4 text-center card-shadow" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                    <div style="font-size: ${(config.font_size || defaultConfig.font_size) * 1.5}px; color: #ffffff;">üìä</div>
                    <div class="font-bold mt-2" style="color: #ffffff; font-size: ${(config.font_size || defaultConfig.font_size) * 1.2}px;">
                      ${activeRentals.length}
                    </div>
                    <div style="color: #ffffff; opacity: 0.9; font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px;">
                      Rental Aktif
                    </div>
                  </div>
                  
                  <div class="rounded-xl p-4 text-center card-shadow" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <div style="font-size: ${(config.font_size || defaultConfig.font_size) * 1.5}px; color: #ffffff;">üí∞</div>
                    <div class="font-bold mt-2" style="color: #ffffff; font-size: ${(config.font_size || defaultConfig.font_size) * 1.2}px;">
                      ${formatCurrency(todayRevenue)}
                    </div>
                    <div style="color: #ffffff; opacity: 0.9; font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px;">
                      Pendapatan Hari Ini
                    </div>
                  </div>
                  
                  <div class="rounded-xl p-4 text-center card-shadow" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <div style="font-size: ${(config.font_size || defaultConfig.font_size) * 1.5}px; color: #ffffff;">üìà</div>
                    <div class="font-bold mt-2" style="color: #ffffff; font-size: ${(config.font_size || defaultConfig.font_size) * 1.2}px;">
                      ${todayRentals.length}
                    </div>
                    <div style="color: #ffffff; opacity: 0.9; font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px;">
                      Transaksi Hari Ini
                    </div>
                  </div>
                  
                  <div class="rounded-xl p-4 text-center card-shadow" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                    <div style="font-size: ${(config.font_size || defaultConfig.font_size) * 1.5}px; color: #ffffff;">üèÜ</div>
                    <div class="font-bold mt-2" style="color: #ffffff; font-size: ${(config.font_size || defaultConfig.font_size) * 1.2}px;">
                      ${formatCurrency(totalRevenue)}
                    </div>
                    <div style="color: #ffffff; opacity: 0.9; font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px;">
                      Total Pendapatan
                    </div>
                  </div>
                </div>
              ` : ''}
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
              <div class="rounded-xl p-6 card-shadow" style="background-color: ${config.surface_color || defaultConfig.surface_color};">
                <h2 class="font-bold mb-4 flex items-center gap-2" style="color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 1.3}px;">
                  <span class="pulse-animation">üü¢</span> Ruangan Tersedia
                </h2>
                
                <div class="space-y-3" id="available-rooms">
                  ${availableRooms.length === 0 ? 
                    `<p style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.6; font-size: ${config.font_size || defaultConfig.font_size}px;">Semua ruangan sedang digunakan</p>` :
                    availableRooms.map(room => {
                      const price = getPriceForRoom(room.type, config);
                      return `
                        <div class="room-card rounded-lg p-4 flex items-center justify-between" 
                          style="background-color: ${config.background_color || defaultConfig.background_color};">
                          <div class="flex items-center gap-3">
                            <span style="font-size: ${(config.font_size || defaultConfig.font_size) * 2}px;">${room.icon}</span>
                            <div>
                              <h3 class="font-semibold" style="color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 1.1}px;">
                                ${room.name}
                              </h3>
                              <p style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.7; font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px;">
                                ${formatCurrency(price)}/jam
                              </p>
                            </div>
                          </div>
                          <button onclick="openStartModal('${room.id}', window.elementSdk.config)" 
                            class="px-4 py-2 rounded-lg font-medium transition-all gradient-bg hover:scale-105"
                            style="color: #ffffff;
                                   font-size: ${config.font_size || defaultConfig.font_size}px;
                                   box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);">
                            ‚ú® Mulai
                          </button>
                        </div>
                      `;
                    }).join('')
                  }
                </div>
              </div>

              <div class="rounded-xl p-6 card-shadow" style="background-color: ${config.surface_color || defaultConfig.surface_color};">
                <h2 class="font-bold mb-4 flex items-center gap-2" style="color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 1.3}px;">
                  <span class="pulse-animation">üî¥</span> Sedang Berjalan
                </h2>
                
                <div class="space-y-3" id="active-rentals">
                  ${activeRentals.length === 0 ? 
                    `<p style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.6; font-size: ${config.font_size || defaultConfig.font_size}px;">Belum ada rental aktif</p>` :
                    activeRentals.map(rental => {
                      const room = REFERENCE_ROOMS.find(r => r.id === rental.room_id);
                      
                      // Inisialisasi variabel, akan di-update oleh startTimer
                      let currentPrice = rental.total_price || 0;
                      let durationDisplay = 'Memuat...';
                      let bookingInfo = 'Memuat...';

                      if (rental.booking_type === 'open' && room) {
                        // Perkiraan awal
                        const duration = calculateDuration(rental.start_time);
                        currentPrice = Math.ceil(duration * getPriceForRoom(room.type, config));
                      }
                      
                      return `
                        <div data-rental-id="${rental.__backendId}" class="rounded-lg p-4" 
                          style="background-color: ${config.background_color || defaultConfig.background_color}; border-left: 4px solid ${config.primary_action_color || defaultConfig.primary_action_color};">
                          <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-2">
                              <span style="font-size: ${(config.font_size || defaultConfig.font_size) * 1.5}px;">${room?.icon || '‚ùì'}</span>
                              <div>
                                <h3 class="font-semibold" style="color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 1.1}px;">
                                  ${room?.name || 'Ruangan Dihapus'}
                                </h3>
                                <p style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.7; font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px;">
                                  ${rental.customer_name}
                                </p>
                              </div>
                            </div>
                            <div class="text-right">
                              <span class="booking-info" style="color: ${config.primary_action_color || defaultConfig.primary_action_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 0.8}px;">
                                ${bookingInfo}
                              </span>
                            </div>
                          </div>
                          
                          <div class="space-y-2 mb-3">
                            <div class="flex justify-between" style="font-size: ${(config.font_size || defaultConfig.font_size) * 0.9}px;">
                              <span style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.8;">Mulai:</span>
                              <span class="font-medium" style="color: ${config.text_color || defaultConfig.text_color};">
                                ${formatTime(rental.start_time)}
                              </span>
                            </div>
                            <div class="flex justify-between" style="font-size: ${(config.font_size || defaultConfig.font_size) * 0.9}px;">
                              <span style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.8;">
                                ${rental.booking_type === 'open' ? 'Durasi:' : 'Status:'}
                              </span>
                              <span class="duration-display font-medium" style="color: ${config.primary_action_color || defaultConfig.primary_action_color};">
                                ${durationDisplay}
                              </span>
                            </div>
                            <div class="flex justify-between" style="font-size: ${(config.font_size || defaultConfig.font_size) * 0.9}px;">
                              <span style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.8;">
                                ${rental.booking_type === 'open' ? 'Total Saat Ini:' : 'Total Bayar:'}
                              </span>
                              <span class="current-price font-bold" style="color: ${config.text_color || defaultConfig.text_color};">
                                ${formatCurrency(currentPrice)}
                              </span>
                            </div>
                          </div>

                          <!-- *** PERUBAHAN DI SINI *** -->
                          <button onclick="handleEndRentalClick('${rental.__backendId}')" 
                            class="end-btn w-full py-2 rounded-lg font-medium transition-all gradient-secondary hover:scale-105"
                            style="color: #ffffff;
                                   font-size: ${config.font_size || defaultConfig.font_size}px;
                                   box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);">
                            üéØ Selesai
                          </button>
                        </div>
                      `;
                    }).join('')
                  }
                </div>
              </div>
            </div>

            ${completedRentals.length > 0 ? `
              <div class="rounded-xl p-6 card-shadow" style="background-color: ${config.surface_color || defaultConfig.surface_color};">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="font-bold" style="color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 1.3}px;">
                    üìã ${isManager ? 'Laporan Transaksi' : 'Riwayat Terakhir'}
                  </h2>
                  ${isManager ? `
                    <div class="flex gap-2">
                      <button onclick="exportReport('today')" class="px-4 py-2 rounded-lg text-sm transition-all gradient-bg hover:scale-105" 
                        style="color: #ffffff; 
                               font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px;
                               box-shadow: 0 2px 10px rgba(6, 182, 212, 0.3);">
                        üìä Laporan Hari Ini
                      </button>
                      <button onclick="exportReport('all')" class="px-4 py-2 rounded-lg text-sm transition-all gradient-secondary hover:scale-105" 
                        style="color: #ffffff; 
                               font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px;
                               box-shadow: 0 2px 10px rgba(245, 158, 11, 0.3);">
                        üìà Laporan Lengkap
                      </button>
                    </div>
                  ` : ''}
                </div>
                
                <div class="overflow-x-auto">
                  <table class="w-full" style="font-size: ${(config.font_size || defaultConfig.font_size) * 0.9}px;">
                    <thead>
                      <tr style="border-bottom: 2px solid ${config.background_color || defaultConfig.background_color};">
                        <th class="text-left p-3" style="color: ${config.text_color || defaultConfig.text_color};">Ruangan</th>
                        <th class="text-left p-3" style="color: ${config.text_color || defaultConfig.text_color};">Pelanggan</th>
                        ${isManager ? `<th class="text-left p-3" style="color: ${config.text_color || defaultConfig.text_color};">Telepon</th>` : ''}
                        <th class="text-left p-3" style="color: ${config.text_color || defaultConfig.text_color};">Tanggal</th>
                        <th class="text-left p-3" style="color: ${config.text_color || defaultConfig.text_color};">Durasi</th>
                        <th class="text-right p-3" style="color: ${config.text_color || defaultConfig.text_color};">Total</th>
                        ${isManager ? `<th class="text-center p-3" style="color: ${config.text_color || defaultConfig.text_color};">Aksi</th>` : ''}
                      </tr>
                    </thead>
                    <tbody>
                      ${(isManager ? completedRentals : completedRentals.slice(0, 5)).map(rental => {
                        const room = REFERENCE_ROOMS.find(r => r.id === rental.room_id);
                        return `
                          <tr style="border-bottom: 1px solid ${config.background_color || defaultConfig.background_color};">
                            <td class="p-3" style="color: ${config.text_color || defaultConfig.text_color};">
                              ${room?.icon || '‚ùì'} ${room?.name || 'Ruangan Dihapus'}
                            </td>
                            <td class="p-3" style="color: ${config.text_color || defaultConfig.text_color};">
                              ${rental.customer_name}
                            </td>
                            ${isManager ? `<td class="p-3" style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.8;">${rental.phone}</td>` : ''}
                            <td class="p-3" style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.8;">
                              ${formatDate(rental.end_time)}
                            </td>
                            <td class="p-3" style="color: ${config.text_color || defaultConfig.text_color};">
                              ${(rental.duration_hours || 0).toFixed(1)} jam
                            </td>
                            <td class="p-3 text-right font-semibold" style="color: ${config.primary_action_color || defaultConfig.primary_action_color};">
                              ${formatCurrency(rental.total_price || 0)}
                            </td>
                            ${isManager ? `
                              <td class="p-3 text-center">
                                <button onclick="showReceiptModal(allRentals.find(r => r.__backendId === '${rental.__backendId}'), REFERENCE_ROOMS.find(r => r.id === '${rental.room_id}'), window.elementSdk.config)" 
                                  class="px-2 py-1 rounded text-sm transition-all" 
                                  style="background-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}; 
                                         color: #ffffff; 
                                         font-size: ${(config.font_size || defaultConfig.font_size) * 0.75}px;">
                                  üßæ Struk
                                </button>
                              </td>
                            ` : ''}
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
                
                ${isManager && completedRentals.length > 0 ? `
                  <div class="mt-4 p-4 rounded" style="background-color: ${config.background_color || defaultConfig.background_color};">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                      <div>
                        <div class="font-bold" style="color: ${config.primary_action_color || defaultConfig.primary_action_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 1.2}px;">
                          ${completedRentals.length}
                        </div>
                        <div style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.7; font-size: ${(config.font_size || defaultConfig.font_size) * 0.9}px;">
                          Total Transaksi
                        </div>
                      </div>
                      <div>
                        <div class="font-bold" style="color: ${config.primary_action_color || defaultConfig.primary_action_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 1.2}px;">
                          ${(completedRentals.reduce((sum, r) => sum + (r.duration_hours || 0), 0)).toFixed(1)} jam
                        </div>
                        <div style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.7; font-size: ${(config.font_size || defaultConfig.font_size) * 0.9}px;">
                          Total Durasi
                        </div>
                      </div>
                      <div>
                        <div class="font-bold" style="color: ${config.primary_action_color || defaultConfig.primary_action_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 1.2}px;">
                          ${formatCurrency(totalRevenue)}
                        </div>
                        <div style="color: ${config.text_color || defaultConfig.text_color}; opacity: 0.7; font-size: ${(config.font_size || defaultConfig.font_size) * 0.9}px;">
                          Total Pendapatan
                        </div>
                      </div>
                    </div>
                  </div>
                ` : ''}
              </div>
            ` : ''}
          </div>
        </div>
      `;

      // Hapus timer yang sudah selesai (untuk rental yang tidak lagi aktif)
      const activeRentalIds = new Set(activeRentals.map(r => r.__backendId));
      activeTimers.forEach((timer, id) => {
          if (!activeRentalIds.has(id)) {
              clearInterval(timer);
              activeTimers.delete(id);
          }
      });
      
      // Mulai timer untuk rental yang aktif
      activeRentals.forEach(rental => {
        // Pastikan rental dan config valid sebelum memulai timer
        if (rental && config) {
          startTimer(rental, config);
        }
      });
    }

    const dataHandler = {
      onDataChanged(data) {
        allRentals = data; // Update module-scoped variable (for renderApp)
        window.allRentals = data; // <-- FIX: Update window-scoped variable (for handleEndRentalClick)
        renderApp(window.elementSdk.config);
      }
    };

    async function onConfigChange(config) {
      renderApp(config);
    }

    // --- Inisialisasi Aplikasi ---
    // FUNGSI BARU UNTUK DIPANGGIL OLEH onAuthStateChanged
    window.initializeAppUI = function() {
      // 1. Render aplikasi dengan config default/tersimpan
      renderApp(window.elementSdk.config);
      
      // 2. Mulai mendengarkan data dari Firebase
      // Ini sekarang aman karena kita sudah diautentikasi
      window.dataSdk.init(dataHandler).then(result => {
        if (!result.isOk) {
          showToast('Gagal menginisialisasi database', 'error');
        } else {
          // Pesan sukses bisa dihapus agar tidak mengganggu
          // showToast('Terhubung ke database real-time', 'success');
          console.log("Berhasil terhubung ke database real-time.");
        }
      });
    }

    function exportReport(type) {
      const config = window.elementSdk.config;
      
      const completedRentals = allRentals
          .filter(r => r.status === 'completed')
          .sort((a, b) => new Date(b.end_time) - new Date(a.end_time));
          
      const today = new Date().toDateString();
      const todayRentals = completedRentals.filter(rental => {
        const rentalDate = new Date(rental.end_time).toDateString();
        return rentalDate === today;
      });

      const dataToExport = type === 'today' ? todayRentals : completedRentals;

      if (dataToExport.length === 0) {
        showToast('Tidak ada data untuk diekspor', 'error');
        return;
      }

      const reportTitle = type === 'today' ? 'Laporan Harian' : 'Laporan Lengkap';
      const reportDate = new Date().toLocaleDateString('id-ID');
      
      let csvContent = `"${config.app_title || defaultConfig.app_title}"\n`;
      csvContent += `"${reportTitle} - ${reportDate}"\n\n`;
      csvContent += `Ruangan,Pelanggan,Telepon,Tanggal,Waktu Mulai,Waktu Selesai,Durasi (jam),Tipe Booking,Total\n`;
      
      dataToExport.forEach(rental => {
        const room = REFERENCE_ROOMS.find(r => r.id === rental.room_id);
        const startDate = new Date(rental.start_time);
        const endDate = new Date(rental.end_time);
        
        csvContent += `"${room?.name || 'N/A'}","${rental.customer_name}","${rental.phone}",`;
        csvContent += `"${endDate.toLocaleDateString('id-ID')}","${startDate.toLocaleTimeString('id-ID')}",`;
        csvContent += `"${endDate.toLocaleTimeString('id-ID')}","${(rental.duration_hours || 0).toFixed(2)}",`;
        csvContent += `"${rental.booking_type === 'open' ? 'Open Time' : rental.booking_type + ' Jam'}",`;
        csvContent += `"${rental.total_price || 0}"\n`;
      });
      
      const totalRevenue = dataToExport.reduce((sum, rental) => sum + (rental.total_price || 0), 0);
      const totalDuration = dataToExport.reduce((sum, rental) => sum + (rental.duration_hours || 0), 0);
      
      csvContent += `\nRingkasan:\n`;
      csvContent += `Total Transaksi,"${dataToExport.length}"\n`;
      csvContent += `Total Durasi,"${totalDuration.toFixed(2)} jam"\n`;
      csvContent += `Total Pendapatan,"${totalRevenue}"\n`;

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `${reportTitle.replace(' ', '_')}_${reportDate.replace(/\//g, '-')}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast(`${reportTitle} berhasil diunduh!`);
    }

    // Pasang fungsi ke window agar bisa di-klik
    window.openStartModal = openStartModal;
    window.closeModal = closeModal;
    // window.endRental = endRental; // endRental sekarang dipanggil oleh handleEndRentalClick
    window.printReceipt = printReceipt;
    window.closeReceiptModal = closeReceiptModal;
    window.showRoleSelector = showRoleSelector;
    window.selectRole = selectRole;
    window.exportReport = exportReport;
    /* window.allRentals = allRentals; */ // <-- DIHAPUS: Baris ini tidak perlu lagi
    window.REFERENCE_ROOMS = REFERENCE_ROOMS;

    // -----------------------------------------------------------------
    // LOGIKA INISIALISASI (DIPERBAIKI - Menggunakan token kustom)
    // -----------------------------------------------------------------
    // Bungkus inisialisasi aplikasi di dalam listener auth
    // Ini memastikan kita login SEBELUM mencoba membaca database
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Pengguna berhasil login (termasuk anonim atau kustom)
        console.log("Otentikasi berhasil, UID:", user.uid);
        
        // Sekarang aman untuk memanggil initializeAppUI
        // karena sudah pasti terdefinisi
        window.initializeAppUI();
        
      } else {
        // Pengguna tidak login, coba login
        console.log("Tidak ada pengguna, mencoba login...");
        try {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            // Gunakan token kustom jika tersedia
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            // Fallback ke login anonim jika tidak ada token
            await signInAnonymously(auth);
          }
          // onAuthStateChanged akan dipanggil lagi secara otomatis setelah login berhasil
        } catch (error) {
          console.error("Login gagal:", error);
          showToast('Gagal terhubung ke server', 'error');
        }
      }
    });

  </script>
</head>
<body class="antliasised">
  <div id="app" class="min-h-full">
    <!-- Konten aplikasi akan dirender di sini oleh renderApp() -->
    <div class="flex items-center justify-center min-h-screen">
      <div class="text-center">
        <div class="text-2xl font-semibold animate-pulse">Memuat Aplikasi...</div>
        <div class="text-gray-500 mt-2">Menghubungkan ke server...</div>
      </div>
    </div>
  </div>
</body>
</html>
